<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Earthquake Emergency - AidGen</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<style>
:root {
    --primary: #6C63FF;
    --text-primary: #2D3748;
    --text-secondary: #718096;
    --bg-color: #F7FAFC;
    --card-bg: #FFFFFF;
    --border-color: #E2E8F0;
    --emergency-tag: #5C3E94;
    --sos-button: #FF4B4B;
    --button-hover: rgba(0,0,0,0.05);
    --sos-shadow: 0 4px 12px rgba(255,75,75,0.3);
    --card-shadow: 0 2px 8px rgba(0,0,0,0.05);

    --chat-user-bg: #5C3E94;
    --chat-bot-bg: #EDE7F6;
    --chat-primary-button: #7E57C2;

    --error-bg: #fff3cd;
    --error-text: #856404;
    --error-border: #ffeeba;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
body { background-color: var(--bg-color); color: var(--text-primary); }

.aidgen-container { 
    max-width: 500px; 
    margin:0 auto; 
    min-height:100vh; 
    padding-bottom:160px; 
    background: linear-gradient(180deg, #f7f5fb 0%, #e8e0f7 100%);
    position: relative; 
}

/* Header */
.header {
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    padding:16px 20px; 
    background-color: var(--card-bg); 
    border-bottom:1px solid var(--border-color); 
    position: sticky; 
    top:0; 
    z-index:100; 
    box-shadow: var(--card-shadow);
}
.header-title { font-weight:700; font-size:20px; }
.back-button, .notification-button { 
    background:none; border:none; padding:8px; cursor:pointer; border-radius:50%; 
    transition:0.2s; 
}
.back-button:hover, .notification-button:hover { background-color: var(--button-hover); }

/* Emergency section */
.selected-emergency { 
    background-color: var(--card-bg); 
    border-radius:16px; 
    padding:20px; 
    margin:20px; 
    border:1px solid var(--border-color); 
    box-shadow: var(--card-shadow); 
}
.emergency-tag { color: var(--emergency-tag); font-size:12px; font-weight:600; margin-bottom:8px; }
.emergency-type { display:flex; align-items:center; font-size:20px; font-weight:700; }
.emergency-icon { 
    width:50px; height:50px; display:flex; align-items:center; justify-content:center; 
    background-color:#3c2a6a; color: var(--emergency-tag); border-radius:12px; 
    font-size:28px; margin-right:14px; 
}

/* SOS Button */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.sos-button { 
    background-color: var(--sos-button); 
    color:white; 
    border:none; 
    border-radius:16px; 
    padding:28px 24px; 
    margin:0 20px 20px; 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    cursor:pointer; 
    width:calc(100% - 40px); 
    box-shadow: var(--sos-shadow); 
    transition: transform 0.15s ease;
    font-size:16px;
    animation: pulse 2s infinite;
}
.sos-button:active { transform: scale(0.97); }

/* What to do */
.what-to-do { 
    background-color: var(--card-bg); 
    border-radius:16px; 
    padding:18px 20px; 
    margin:0 20px 20px; 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    border:1px solid var(--border-color); 
    box-shadow: var(--card-shadow); 
    cursor:pointer; 
    text-decoration:none; 
    color:inherit; 
    transition:0.2s; 
}
.what-to-do:hover { background-color:#F1EEFB; }
.book-icon { 
    font-size:28px; 
    background-color:#EFEAFF; 
    padding:12px; 
    width:50px; 
    height:50px; 
    border-radius:12px; 
    display:flex; justify-content:center; align-items:center; 
    color:var(--emergency-tag); margin-right:14px; 
}

/* Instructions */
.instructions-container { 
    padding:20px; margin:20px; 
    background: var(--card-bg); 
    border-radius:16px; 
    border:1px solid var(--border-color); 
    box-shadow: var(--card-shadow); 
    display:none; 
}

/* Chatbox */
#chatbot-box { 
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); 
    width: 95%; max-width: 520px; 
    background: var(--card-bg); 
    border-top-left-radius: 28px; border-top-right-radius: 28px; 
    border: 1px solid rgba(0,0,0,0.08); 
    box-shadow: 0 20px 35px rgba(0,0,0,0.15); 
    z-index:1000; display:flex; flex-direction:column; gap:0; overflow:hidden; 
}
.chat-header { 
    padding:12px 18px; background:#f2ebff; 
    border-bottom:1px solid rgba(0,0,0,0.05); 
    display:flex; align-items:center; justify-content:space-between; gap:10px; 
}
#chat-messages { 
    max-height:300px; height:auto; overflow-y:auto; padding:15px 10px; 
    display:flex; flex-direction:column; gap:10px; background-color:#f7f7f9; 
}
.chat-msg { 
    padding:10px 15px; border-radius:18px; max-width:85%; font-size:15px; 
    line-height:1.4; word-wrap:break-word; box-shadow:0 1px 2px rgba(0,0,0,0.05); 
}
.user-msg { 
    background: var(--chat-user-bg); 
    align-self:flex-end; 
    color:white; 
    border-bottom-right-radius:4px; 
}
.bot-msg { 
    background: var(--chat-bot-bg); 
    align-self:flex-start; 
    color:var(--text-primary); 
    border-bottom-left-radius:4px; 
}
.error-msg {
    background-color: var(--error-bg);
    color: var(--error-text);
    align-self:flex-start;
    border: 1px solid var(--error-border);
    border-radius: 8px;
    padding: 10px 15px;
    font-weight: 600;
    max-width: 95%;
}

#chat-input { display:flex; padding:12px 15px; border-top:1px solid var(--border-color); align-items:center; background:var(--card-bg); }
#chat-input input { flex:1; padding:10px 18px; border-radius:25px; border:1px solid var(--border-color); outline:none; margin-right:10px; font-size:16px; transition:border-color 0.2s; }
#chat-input input:focus { border-color: var(--primary); }
#chat-input button { padding:10px 18px; border:none; border-radius:25px; background-color: var(--chat-primary-button); color:white; cursor:pointer; font-weight:600; transition:0.2s; }
#chat-input button:hover { background-color:#5E35B1; }

/* Prebuilt commands */
.prebuilt-command { 
    background:white; border:1px solid var(--border-color); 
    border-radius:16px; padding:8px 12px; font-size:13px; color:#4a5568; 
    cursor:pointer; transition: all 0.2s; white-space:nowrap; margin:2px 0; 
}
.prebuilt-command:hover { background:#f0f4f8; border-color:#cbd5e0; transform: translateY(-1px); }
.prebuilt-command:active { transform: translateY(0); }

/* Responsive */
@media (max-width:640px){ 
    #chatbot-box{width:100%; left:0; transform:none; border-radius:0; max-width:none;} 
    #chat-messages{max-height:45vh; padding:12px 12px;} 
    #chat-input{padding:10px;} 
    #chat-input input{font-size:14px;} 
}
@media (max-width:480px){ 
    .chat-header h3{font-size:15px;} 
    .chat-header .chat-subtitle{display:none;} 
}
</style>
</head>
<body>

<div class="aidgen-container">

<header class="header">
    <button class="back-button" aria-label="Go back" onclick="window.history.back()"><span class="material-symbols-outlined">arrow_back</span></button>
    <h1 class="header-title">AIDGEN</h1>
    <button class="notification-button" aria-label="Notifications"><span class="material-symbols-outlined">notifications_none</span></button>
</header>

<section class="selected-emergency">
    <p class="emergency-tag">SELECTED EMERGENCY</p>
    <div class="emergency-type">
        <div class="emergency-icon">üèöÔ∏è</div>
        EARTHQUAKE
    </div>
</section>

<button class="sos-button" id="sos-button" aria-label="Send SOS">
    <div>
        <div style="font-size:20px;font-weight:700;">SEND SOS</div>
        <div style="opacity:0.85;">Share Live Location</div>
    </div>
    <div style="font-size:36px;">üì°</div>
</button>

<div class="what-to-do" id="safety-guide-btn">
    <div style="display:flex; align-items:center;">
        <div class="book-icon">üìñ</div>
        <div>
            <h2 style="font-weight:600;">What to do?</h2>
            <p style="font-size:14px;color:var(--text-secondary);">Safety guides & first steps</p>
        </div>
    </div>
    <span class="material-symbols-outlined">chevron_right</span>
</div>

<div id="instructions" class="instructions-container"></div>

<div id="prebuilt-commands" style="padding:10px 20px 20px; display:flex; flex-wrap:wrap; gap:8px;">
    <button class="prebuilt-command" data-command="What should I do during an earthquake?">üö® Immediate Actions</button>
    <button class="prebuilt-command" data-command="Where are the nearest shelters?">üè† Find Shelters</button>
    <button class="prebuilt-command" data-command="How to prepare an emergency kit?">üéí Emergency Kit</button>
    <button class="prebuilt-command" data-command="First aid for injuries">ü©π First Aid</button>
</div>

<div id="chatbot-box">
    <div id="chat-messages"></div>
    <div id="chat-input">
        <input type="text" id="userInput" placeholder="Ask AidGen..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
const chatMessages = document.getElementById("chat-messages");
const chatInputEl = document.getElementById("userInput");
const chatButtonEl = document.querySelector("#chat-input button");
const CHAT_API_URL = `${window.location.origin}/api/chat`;

const setChatButtonLoading = (isLoading) => {
    if (!chatButtonEl) return;
    chatButtonEl.disabled = isLoading;
    chatButtonEl.innerText = isLoading ? "Thinking..." : "Send";
    chatButtonEl.style.opacity = isLoading ? "0.7" : "1";
};

const HELP_COMMAND = "/help";
let awaitingHelpDetails = false;

function addMessage(sender, text){
    const div = document.createElement("div");
    
    if(sender === "bot" && text.startsWith("‚ö†Ô∏è Error")) {
        div.className = "chat-msg error-msg";
    } else {
        div.className = sender === "user" ? "chat-msg user-msg" : "chat-msg bot-msg";
    }

    div.innerText = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage() {
    if (!chatInputEl) return;
    const text = chatInputEl.value.trim();
    if (!text) return;

    if (text.toLowerCase() === HELP_COMMAND) {
        addMessage("user", text);
        addMessage("bot", "Absolutely. What do you need help with? Provide a brief description and I'll guide you through next steps.");
        awaitingHelpDetails = true;
        chatInputEl.value = "";
        return;
    }

    const helpContext = awaitingHelpDetails;
    addMessage("user", text);
    chatInputEl.value = "";
    setChatButtonLoading(true);

    try {
        const res = await fetch(CHAT_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, help_context: helpContext, emergency_type:"earthquake" })
        });
        const data = await res.json().catch(() => null);
        if (res.ok && data?.ok) addMessage("bot", data.reply);
        else addMessage("bot", `‚ö†Ô∏è Error: ${data?.error || data?.details || res.statusText || "Unknown chat error"}`);
    } catch(err){
        addMessage("bot", "‚ö†Ô∏è Error: Cannot connect to chat service.");
    } finally {
        setChatButtonLoading(false);
        awaitingHelpDetails = false;
    }
}

// Prebuilt commands
document.querySelectorAll('.prebuilt-command').forEach(button=>{
    button.addEventListener('click', ()=>{
        const command = button.dataset.command;
        if(command){
            chatInputEl.value = command;
            sendMessage();
        }
    });
});

// SOS logic
const getCurrentPosition = () => new Promise(resolve=>{
    if(!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(resolve, ()=>resolve(null), { enableHighAccuracy:true, timeout:15000 });
});

document.getElementById("sos-button").addEventListener("click", async ()=>{
    const position = await getCurrentPosition();
    const payload = { type:"earthquake", latitude:position?.coords?.latitude, longitude:position?.coords?.longitude, location: position ? `Lat:${position.coords.latitude.toFixed(5)}, Long:${position.coords.longitude.toFixed(5)}` : null };
    try {
        const res = await fetch("/api/sos",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
        const data = await res.json().catch(()=>null);
        if(!res.ok || !data?.ok) throw new Error(data?.error || data?.details?.error || res.statusText);
        alert("üö® SOS Alert Sent! Your location is being shared.");
    } catch(err){
        alert(`SOS failed: ${err.message}`);
    }
});

// Safety instructions toggle
document.getElementById("safety-guide-btn").addEventListener("click", ()=>{
    const instructions = document.getElementById("instructions");
    if(instructions.style.display === "block"){
        instructions.style.display = "none";
    } else {
        instructions.innerHTML = `
            <h3 style="margin-bottom:10px;font-weight:700;">üèöÔ∏è Earthquake Safety Instructions</h3>
            <ul style="padding-left:20px;line-height:1.7;">
                <li><strong>Drop, Cover, and Hold On</strong> immediately.</li>
                <li>Stay away from <strong>windows, mirrors</strong>, and heavy objects that could fall.</li>
                <li>Take shelter under sturdy furniture (table, desk).</li>
                <li>If outdoors, move to an <strong>open space</strong> away from trees, buildings, and utility poles.</li>
                <li>Once shaking stops, evacuate carefully and safely.</li>
                <li><strong>Avoid elevators</strong> and severely damaged structures.</li>
            </ul>`;
        instructions.style.display = "block";
        instructions.scrollIntoView({behavior:"smooth"});
    }
});
</script>
</body>
</html>
