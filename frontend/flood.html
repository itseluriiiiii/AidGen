<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flood Emergency - AidGen</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<style>
:root {
    --primary: #6C63FF;
    --text-primary: #2D3748;
    --text-secondary: #718096;
    --bg-color: #E8F0FE;
    --card-bg: #FFFFFF;
    --border-color: #E2E8F0;
    --emergency-tag: #161179;
    --sos-button: #FF4B4B;
    --button-hover: rgba(0,0,0,0.05);
    --sos-shadow: 0 4px 12px rgba(255,75,75,0.3);
    --card-shadow: 0 2px 8px rgba(0,0,0,0.05);

    /* Chat */
    --chat-user-bg: #5C3E94;
    --chat-bot-bg: #EDE7F6;
    --chat-primary-button: #7E57C2;

    /* Error styling */
    --error-bg: #fff3cd;
    --error-text: #856404;
    --error-border: #ffeeba;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
body { background-color: var(--bg-color); color: var(--text-primary); }

.aidgen-container { max-width:500px; margin:0 auto; min-height:100vh; padding-bottom:140px; }

.header {
    display:flex; justify-content:space-between; align-items:center;
    padding:16px 20px; background-color:var(--card-bg);
    border-bottom:1px solid var(--border-color);
    position:sticky; top:0; z-index:10;
}

.back-button, .notification-button {
    background:none; border:none; padding:8px; border-radius:50%; cursor:pointer; transition:0.2s;
}
.back-button:hover, .notification-button:hover { background-color: var(--button-hover); }

.header-title { font-size:18px; font-weight:700; }

.selected-emergency {
    background:var(--card-bg); margin:20px; padding:20px;
    border-radius:12px; border:1px solid var(--border-color);
    box-shadow: var(--card-shadow);
}

.emergency-tag { font-size:12px; font-weight:600; margin-bottom:8px; color: var(--emergency-tag); }
.emergency-type { display:flex; align-items:center; font-size:20px; font-weight:700; }
.emergency-icon {
    background:#04093f; color:white; width:40px; height:40px;
    border-radius:10px; display:flex; justify-content:center; align-items:center;
    margin-right:12px; font-size:22px;
}

.sos-button {
    background: var(--sos-button); color:white; border:none;
    width:calc(100% - 40px); margin:20px; padding:28px 24px;
    border-radius:16px; display:flex; justify-content:space-between;
    align-items:center; cursor:pointer; box-shadow: var(--sos-shadow);
    transition:0.2s;
}
.sos-button:active { transform:scale(0.98); }

.what-to-do {
    background:var(--card-bg); border-radius:14px; margin:0 20px; padding:16px 20px;
    display:flex; justify-content:space-between; align-items:center;
    box-shadow: var(--card-shadow); cursor:pointer; text-decoration:none; color:inherit;
}

.book-icon {
    background:#F0F4FF; width:50px; height:50px; display:flex; justify-content:center; align-items:center;
    border-radius:12px; margin-right:16px; font-size:24px; color:#4C6FFF;
}

.instructions-box {
    background:var(--card-bg); margin:20px; padding:16px 20px;
    border-radius:12px; border:1px solid var(--border-color);
    box-shadow: var(--card-shadow); display:none;
}

/* CHATBOT */
#chatbot-box {
    font-family:'Inter',sans-serif; position:fixed; bottom:0; left:50%;
    transform:translateX(-50%); width:95%; max-width:520px;
    background:var(--card-bg); border-top-left-radius:28px; border-top-right-radius:28px;
    border:1px solid rgba(0,0,0,0.08); box-shadow:0 20px 35px rgba(0,0,0,0.15);
    display:flex; flex-direction:column; gap:0; overflow:hidden; z-index:1000;
}
#chat-messages {
    max-height:300px; overflow-y:auto; padding:15px 10px;
    display:flex; flex-direction:column; gap:10px; background-color:#f7f7f9;
}
.chat-msg { padding:10px 15px; border-radius:18px; max-width:85%; font-size:15px; line-height:1.4; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
.user-msg { background:var(--chat-user-bg); align-self:flex-end; color:white; border-bottom-right-radius:4px; }
.bot-msg { background:var(--chat-bot-bg); align-self:flex-start; color:var(--text-primary); border-bottom-left-radius:4px; }
.error-msg { background:var(--error-bg); color:var(--error-text); align-self:flex-start; border:1px solid var(--error-border); border-radius:8px; padding:10px 15px; font-weight:600; max-width:95%; }

#chat-input { display:flex; padding:12px 15px; border-top:1px solid var(--border-color); background:var(--card-bg); align-items:center; }
#chat-input input { flex:1; padding:10px 18px; border-radius:25px; border:1px solid var(--border-color); outline:none; margin-right:10px; font-size:16px; }
#chat-input input:focus { border-color:var(--primary); }
#chat-input input::placeholder { color:var(--text-secondary); }
#chat-input button { padding:10px 18px; border:none; border-radius:25px; background-color:var(--chat-primary-button); color:white; cursor:pointer; font-weight:600; transition:0.2s; }
#chat-input button:hover { background-color:#5E35B1; }

@media(max-width:640px) { #chatbot-box { width:100%; left:0; transform:none; border-radius:0; } #chat-messages { max-height:45vh; padding:12px; } #chat-input input { font-size:14px; } }
@media(max-width:480px){ .selected-emergency,.sos-button,.what-to-do,.instructions-box { margin-left:16px;margin-right:16px; } }

</style>
</head>
<body>

<div class="aidgen-container">

<header class="header">
    <button class="back-button" onclick="window.history.back()">
        <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <h1 class="header-title">AIDGEN</h1>
    <button class="notification-button">
        <span class="material-symbols-outlined">notifications_none</span>
    </button>
</header>

<section class="selected-emergency">
    <p class="emergency-tag">SELECTED EMERGENCY</p>
    <div class="emergency-type">
        <span class="emergency-icon">üåä</span> FLOOD
    </div>
</section>

<button class="sos-button" id="sos-button">
    <div>
        <div style="font-size:24px;font-weight:700;">SEND SOS</div>
        <div style="opacity:0.8;">Share Live Location</div>
    </div>
    <div style="font-size:36px;">üì°</div>
</button>

<div class="what-to-do" id="safety-guide-btn">
    <div style="display:flex;align-items:center;">
        <span class="book-icon">üìñ</span>
        <div>
            <div style="font-weight:600;">What to do?</div>
            <div style="font-size:14px;color:var(--text-secondary);">Safety guides & first steps</div>
        </div>
    </div>
    <span class="material-symbols-outlined">chevron_right</span>
</div>

<div id="instructions" class="instructions-box"></div>

<div id="chatbot-box">
    <div id="chat-messages"></div>
    <div id="chat-input">
        <input type="text" id="userInput" placeholder="Ask AidGen..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

</div>

<script>
const getCurrentPosition = () => new Promise(resolve => {
    if(!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(resolve, ()=>resolve(null), { enableHighAccuracy:true, timeout:15000 });
});

const sendSOS = async (type) => {
    const pos = await getCurrentPosition();
    const payload = {
        type,
        latitude: pos?.coords?.latitude,
        longitude: pos?.coords?.longitude,
        location: pos ? `Lat: ${pos.coords.latitude.toFixed(5)}, Long: ${pos.coords.longitude.toFixed(5)}` : null
    };

    try {
        const res = await fetch("/api/sos", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>null);
        if(!res.ok || !data?.ok) throw new Error(data?.error || data?.details?.error || res.statusText);
        alert("üö® SOS Alert Sent!\nYour location is being shared.");
    } catch(err) {
        alert(`SOS failed: ${err.message}`);
    }
}

document.getElementById("sos-button").addEventListener("click", async ()=>{ await sendSOS("flood"); });

document.getElementById("safety-guide-btn").addEventListener("click", ()=>{
    const instructions = document.getElementById("instructions");
    instructions.innerHTML = `
        <h3 style="margin-bottom:10px;font-weight:700;">üåä Flood Safety Instructions</h3>
        <ul style="padding-left:20px;line-height:1.7;">
            <li><strong>Move to higher ground</strong> immediately.</li>
            <li>Avoid walking or driving through <strong>flood waters</strong>.</li>
            <li>Follow <strong>evacuation orders</strong> from authorities.</li>
            <li>Do not touch <strong>electrical equipment</strong> if wet.</li>
            <li>Stay away from rapidly <strong>moving water</strong>.</li>
            <li>Keep <strong>emergency supplies</strong> ready.</li>
        </ul>
    `;
    instructions.style.display = "block";
    instructions.scrollIntoView({ behavior: "smooth" });
});

const chatMessages = document.getElementById("chat-messages");
const chatInputEl = document.getElementById("userInput");
const chatButtonEl = document.querySelector("#chat-input button");
const CHAT_API_URL = window.location?.origin && window.location.origin!=="null" ? `${window.location.origin}/api/chat` : "http://localhost:5000/api/chat";
let awaitingHelpDetails = false;

const setChatButtonLoading = (isLoading) => {
    chatButtonEl.disabled = isLoading;
    chatButtonEl.innerText = isLoading ? "Thinking..." : "Send";
    chatButtonEl.style.opacity = isLoading ? "0.7" : "1";
}

async function sendMessage() {
    const text = chatInputEl.value.trim();
    if(!text) return;

    addMessage("user", text);
    chatInputEl.value = "";
    setChatButtonLoading(true);

    try {
        const res = await fetch(CHAT_API_URL,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ message:text, help_context:awaitingHelpDetails })
        });
        const data = await res.json().catch(()=>null);
        if(res.ok && data?.ok) addMessage("bot", data.reply);
        else addMessage("bot", `‚ö†Ô∏è Error: ${data?.error || data?.details || res.statusText || "Unknown chat error"}`);
    } catch(err){
        addMessage("bot", "‚ö†Ô∏è Error: Cannot connect to chat service.");
    } finally {
        setChatButtonLoading(false);
        awaitingHelpDetails = false;
    }
}

function addMessage(sender, text){
    const div = document.createElement("div");
    if(sender==="bot" && text.includes("Cannot connect to chat service")) div.className = "chat-msg error-msg";
    else div.className = sender==="user" ? "chat-msg user-msg" : "chat-msg bot-msg";
    div.innerText = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>

</body>
</html>
